<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>Communication - Administration</title>
</head>
<body>

<section>
    <div class="container-fluid">
        <!-- En-tête de la page -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Communication</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sendNotificationModal">
                <i class="fas fa-paper-plane me-2"></i>Envoyer une Notification
            </button>
        </div>

        <!-- Statistiques de communication -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Notifications Envoyées</h5>
                        <h3 th:text="${notificationsEnvoyees}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">Taux de Lecture</h5>
                        <h3 th:text="${tauxLecture} + '%'">0%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">Étudiants Actifs</h5>
                        <h3 th:text="${etudiantsActifs}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">En Attente</h5>
                        <h3 th:text="${notificationsEnAttente}">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mb-4" id="communicationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button" role="tab">
                    <i class="fas fa-paper-plane me-2"></i>Envoyer
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                    <i class="fas fa-history me-2"></i>Historique
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                    <i class="fas fa-file-alt me-2"></i>Modèles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="fas fa-chart-line me-2"></i>Analytiques
                </button>
            </li>
        </ul>

        <div class="tab-content" id="communicationTabsContent">
            <!-- Onglet Envoyer -->
            <div class="tab-pane fade show active" id="send" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Composer une Notification</h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/admin/communication/send}" method="post">
                                    <div class="mb-3">
                                        <label for="titre" class="form-label">Titre de la Notification *</label>
                                        <input type="text" class="form-control" id="titre" name="titre" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="message" class="form-label">Message *</label>
                                        <textarea class="form-control" id="message" name="message" rows="6" required></textarea>
                                        <div class="form-text">Maximum 500 caractères</div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="type" class="form-label">Type de Notification</label>
                                                <select class="form-select" id="type" name="type">
                                                    <option value="INFO">Information</option>
                                                    <option value="URGENT">Urgent</option>
                                                    <option value="EVENT">Événement</option>
                                                    <option value="CLUB">Club</option>
                                                    <option value="GENERAL">Général</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="priorite" class="form-label">Priorité</label>
                                                <select class="form-select" id="priorite" name="priorite">
                                                    <option value="NORMALE">Normale</option>
                                                    <option value="HAUTE">Haute</option>
                                                    <option value="CRITIQUE">Critique</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Destinataires</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allStudents" name="destinataires" value="ALL_STUDENTS" checked>
                                                    <label class="form-check-label" for="allStudents">
                                                        Tous les étudiants
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allClubs" name="destinataires" value="ALL_CLUBS">
                                                    <label class="form-check-label" for="allClubs">
                                                        Tous les clubs
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="specificClub" name="destinataires" value="SPECIFIC_CLUB">
                                                    <label class="form-check-label" for="specificClub">
                                                        Club spécifique
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="admins" name="destinataires" value="ADMINS">
                                                    <label class="form-check-label" for="admins">
                                                        Administrateurs
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3" id="clubSelection" style="display: none;">
                                        <label for="clubId" class="form-label">Sélectionner un Club</label>
                                        <select class="form-select" id="clubId" name="clubId">
                                            <option value="">Choisir un club...</option>
                                            <option th:each="club : ${clubs}" th:value="${club.id}" th:text="${club.nom}">Club</option>
                                        </select>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dateEnvoi" class="form-label">Date d'Envoi</label>
                                                <input type="datetime-local" class="form-control" id="dateEnvoi" name="dateEnvoi">
                                                <div class="form-text">Laisser vide pour envoyer immédiatement</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="emailNotification" name="emailNotification">
                                                    <label class="form-check-label" for="emailNotification">
                                                        Envoyer aussi par email
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary" onclick="previewNotification()">
                                            <i class="fas fa-eye me-2"></i>Aperçu
                                        </button>
                                        <div>
                                            <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                                                <i class="fas fa-save me-2"></i>Brouillon
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-paper-plane me-2"></i>Envoyer
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Panneau latéral -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Aperçu</h6>
                            </div>
                            <div class="card-body">
                                <div id="notificationPreview">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-mobile-alt fa-2x mb-2"></i>
                                        <p>L'aperçu apparaîtra ici</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Conseils</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-lightbulb me-2"></i>Conseils :</h6>
                                    <ul class="mb-0 small">
                                        <li>Soyez concis et clair</li>
                                        <li>Utilisez un titre accrocheur</li>
                                        <li>Évitez les majuscules excessives</li>
                                        <li>Incluez un appel à l'action</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Historique -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Historique des Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Type</th>
                                        <th>Destinataires</th>
                                        <th>Date d'Envoi</th>
                                        <th>Statut</th>
                                        <th>Taux de Lecture</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="notification : ${notifications}">
                                        <td th:text="${notification.titre}">Titre</td>
                                        <td>
                                            <span class="badge" th:classappend="${notification.type == 'URGENT'} ? 'bg-danger' : (${notification.type == 'EVENT'} ? 'bg-success' : 'bg-primary')" th:text="${notification.type}">Type</span>
                                        </td>
                                        <td th:text="${notification.destinataires}">Destinataires</td>
                                        <td th:text="${#temporals.format(notification.dateEnvoi, 'dd/MM/yyyy HH:mm')}">Date</td>
                                        <td>
                                            <span class="badge" th:classappend="${notification.statut == 'ENVOYE'} ? 'bg-success' : (${notification.statut == 'EN_ATTENTE'} ? 'bg-warning' : 'bg-secondary')" th:text="${notification.statut}">Statut</span>
                                        </td>
                                        <td th:text="${notification.tauxLecture} + '%'">0%</td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm" th:onclick="'viewNotification(' + ${notification.id} + ')'">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Modèles -->
            <div class="tab-pane fade" id="templates" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Modèle d'Événement</h6>
                                <p class="small text-muted">Pour annoncer un nouvel événement</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('event')">Utiliser</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Modèle d'Urgence</h6>
                                <p class="small text-muted">Pour les communications urgentes</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('urgent')">Utiliser</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Modèle de Club</h6>
                                <p class="small text-muted">Pour les annonces de club</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('club')">Utiliser</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>Modèle Général</h6>
                                <p class="small text-muted">Pour les informations générales</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="useTemplate('general')">Utiliser</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Analytiques -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Taux de Lecture par Type</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="readRateChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Notifications par Mois</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="monthlyChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Gestion de l'affichage du sélecteur de club
    document.getElementById('specificClub').addEventListener('change', function() {
        const clubSelection = document.getElementById('clubSelection');
        clubSelection.style.display = this.checked ? 'block' : 'none';
    });

    // Fonction d'aperçu
    function previewNotification() {
        const titre = document.getElementById('titre').value;
        const message = document.getElementById('message').value;
        const type = document.getElementById('type').value;
        
        if (!titre || !message) {
            alert('Veuillez remplir le titre et le message pour voir l\'aperçu.');
            return;
        }
        
        const preview = document.getElementById('notificationPreview');
        const typeColors = {
            'INFO': 'primary',
            'URGENT': 'danger',
            'EVENT': 'success',
            'CLUB': 'info',
            'GENERAL': 'secondary'
        };
        
        preview.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">${titre}</h6>
                        <span class="badge bg-${typeColors[type]}">${type}</span>
                    </div>
                    <p class="mb-0 small">${message}</p>
                    <div class="text-muted mt-2">
                        <small>Maintenant</small>
                    </div>
                </div>
            </div>
        `;
    }

    // Mise à jour automatique de l'aperçu
    document.getElementById('titre').addEventListener('input', previewNotification);
    document.getElementById('message').addEventListener('input', previewNotification);
    document.getElementById('type').addEventListener('change', previewNotification);

    // Fonction pour utiliser un modèle
    function useTemplate(templateType) {
        const templates = {
            'event': {
                titre: 'Nouvel Événement : [Titre]',
                message: 'Nous avons le plaisir de vous annoncer un nouvel événement : [Titre]\n\n📅 Date : [Date]\n📍 Lieu : [Lieu]\n\nInscrivez-vous dès maintenant !'
            },
            'urgent': {
                titre: 'URGENT - [Sujet]',
                message: 'ATTENTION : [Message urgent]\n\nVeuillez prendre connaissance de cette information importante.'
            },
            'club': {
                titre: 'Annonce du Club [Nom]',
                message: 'Le club [Nom] vous informe :\n\n[Message]\n\nPour plus d\'informations, contactez le club.'
            },
            'general': {
                titre: 'Information Importante',
                message: 'Chers étudiants,\n\n[Message]\n\nMerci de votre attention.'
            }
        };
        
        const template = templates[templateType];
        if (template) {
            document.getElementById('titre').value = template.titre;
            document.getElementById('message').value = template.message;
            previewNotification();
        }
    }

    // Fonction pour sauvegarder en brouillon
    function saveDraft() {
        const titre = document.getElementById('titre').value;
        const message = document.getElementById('message').value;
        
        if (!titre || !message) {
            alert('Veuillez remplir le titre et le message pour sauvegarder.');
            return;
        }
        
        // Ici, vous pourriez envoyer une requête AJAX pour sauvegarder le brouillon
        alert('Brouillon sauvegardé !');
    }

    // Fonction pour voir une notification
    function viewNotification(notificationId) {
        // Ici, vous pourriez ouvrir un modal avec les détails de la notification
        alert('Voir les détails de la notification ' + notificationId);
    }

    // Validation du formulaire
    document.querySelector('form').addEventListener('submit', function(e) {
        const message = document.getElementById('message').value;
        if (message.length > 500) {
            e.preventDefault();
            alert('Le message ne peut pas dépasser 500 caractères.');
            return;
        }
        
        const destinataires = document.querySelectorAll('input[name="destinataires"]:checked');
        if (destinataires.length === 0) {
            e.preventDefault();
            alert('Veuillez sélectionner au moins un destinataire.');
            return;
        }
        
        if (document.getElementById('specificClub').checked && !document.getElementById('clubId').value) {
            e.preventDefault();
            alert('Veuillez sélectionner un club spécifique.');
            return;
        }
    });
</script>

</body>
</html>
